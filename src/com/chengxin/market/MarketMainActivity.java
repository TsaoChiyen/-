package com.chengxin.market;import java.util.ArrayList;import java.util.List;import android.content.BroadcastReceiver;import android.content.Context;import android.content.Intent;import android.content.IntentFilter;import android.content.SharedPreferences;import android.graphics.Color;import android.os.Build;import android.os.Bundle;import android.os.Handler;import android.text.TextUtils;import android.util.Log;import android.view.Gravity;import android.view.View;import android.view.View.OnClickListener;import android.widget.Button;import android.widget.LinearLayout;import android.widget.RelativeLayout;import android.widget.TextView;import com.chengxin.ApplyMerchantActivity;import com.chengxin.BaseActivity;import com.chengxin.MainActivity;import com.chengxin.ModifyPwdActivity;import com.chengxin.R;import com.chengxin.SendMovingActivity;import com.chengxin.ShoppingCartActivity;import com.chengxin.Entity.Login;import com.chengxin.Entity.PopItem;import com.chengxin.MainActivity.MyPagerAdapter;import com.chengxin.fragment.ChatFragment;import com.chengxin.fragment.GoodsListFragment;import com.chengxin.fragment.MerchantFragment;import com.chengxin.global.FeatureFunction;import com.chengxin.global.GlobalParam;import com.chengxin.global.GlobleType;import com.chengxin.global.WeiYuanCommon;import com.chengxin.profile.shopping.ShoppingManagerActivity;import com.chengxin.widget.PopWindows;import com.chengxin.widget.PopWindows.PopWindowsInterface;public class MarketMainActivity extends BaseActivity implements OnClickListener {	protected static final int REQUEST_VERIFY_PASSWORD = 0x104;	private LinearLayout mLayoutGoods;	private Button mButtonGoods;	private Button mButtonShop;	private TextView mButtonNotice;	private LinearLayout mLayoutShop;	private RelativeLayout mBuyBtn;	private TextView mGoodsCountTextView;	private GoodsListFragment goodsListFragment;	private MerchantFragment shopListFragment;	private int currPage;	private List<PopItem> mPopList = new ArrayList<PopItem>();	private PopWindows mPopWindows;	private RelativeLayout mTitleLayout;	@Override	protected void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		mContext = this;		setContentView(R.layout.market_main_activity);		initComponent();	}	public void initComponent() {		setTitleContent(R.drawable.back_btn, true, false, true, R.string.market_main_title);		mLeftBtn.setOnClickListener(this);		mSearchBtn.setOnClickListener(this);		mMoreBtn.setOnClickListener(this);		mTitleLayout = (RelativeLayout) findViewById(R.id.title_layout);		IntentFilter filter = new IntentFilter();		filter.addAction(GlobalParam.ACTION_REFRESH_MERCHANT_GOODS_COUNT);		mContext.registerReceiver(mRefreshReceiver, filter);		mBuyBtn = (RelativeLayout) findViewById(R.id.buy_btn);		mBuyBtn.setOnClickListener(this);		mGoodsCountTextView = (TextView) findViewById(R.id.shpping_number);		mGoodsCountTextView.setText(WeiYuanCommon.getGoodsCount(1) + "");		mLayoutGoods = (LinearLayout) findViewById(R.id.product_layout);		mLayoutShop = (LinearLayout) findViewById(R.id.shop_layout);		goodsListFragment = (GoodsListFragment) getSupportFragmentManager()				.findFragmentById(R.id.goods_list_fragment);		shopListFragment = (MerchantFragment) getSupportFragmentManager()				.findFragmentById(R.id.shop_goods_fragment);		goodsListFragment.setShopType(1);		shopListFragment.setShopType(1);				mButtonGoods = (Button) findViewById(R.id.btn_goods);		mButtonShop = (Button) findViewById(R.id.btn_shop);		mButtonNotice = (TextView) findViewById(R.id.btn_notice);		mButtonGoods.setOnClickListener(this);		mButtonShop.setOnClickListener(this);		mButtonNotice.setOnClickListener(this);		Login login = WeiYuanCommon.getLoginResult(mContext);				boolean marketAdded = false;				mPopList.clear();				if (login!=null ) {			if (login.isbasket == 1) {				mPopList.add(new PopItem(1, mContext.getString(R.string.menu_basketmanager)));				marketAdded = true;			}		}		if (!marketAdded)	mPopList.add(new PopItem(1, mContext.getString(R.string.menu_applybasket)));		mPopWindows = new PopWindows(mContext, mPopList, mTitleLayout, new PopWindowsInterface() {			@Override			public void onItemClick(int dataId, int position, View view) {				Login login = WeiYuanCommon.getLoginResult(mContext);				switch (dataId) {				case 1:					if (login.isbasket == 1) {						if (login.hasBasketPass == 1) {							Intent intent = new Intent();							intent.setClass(mContext, ModifyPwdActivity.class);							intent.putExtra("type", ModifyPwdActivity.PWD_VERIFY);							intent.putExtra("passtype", ModifyPwdActivity.BASKET_PWD);							startActivityForResult(intent, REQUEST_VERIFY_PASSWORD);						} else {							Intent basketIntent = new Intent();							basketIntent.setClass(mContext, ShoppingManagerActivity.class);							basketIntent.putExtra("type", GlobleType.BASKET_MANAGER);							startActivity(basketIntent);						}					} else {						Intent basketIntent = new Intent();						basketIntent.setClass(mContext, ApplyMerchantActivity.class);						basketIntent.putExtra("type", GlobleType.BASKET_MANAGER);						startActivity(basketIntent);					}				 	break;				}			}		});	}	@Override	public void onDestroy() {		super.onDestroy();		System.gc();		if (mRefreshReceiver != null) {			mContext.unregisterReceiver(mRefreshReceiver);		}	}	@Override	public void onClick(View v) {		switch (v.getId()) {		case R.id.left_btn:			this.finish();			break;		case R.id.search_btn:			startSearch();			break;		case R.id.buy_btn:			Intent cartIntent = new Intent();			cartIntent.setClass(mContext, ShoppingCartActivity.class);			cartIntent.putExtra("shop_type", 1);			startActivity(cartIntent);			break;		case R.id.more_btn:			mPopWindows.showGroupPopView(mPopList,Gravity.RIGHT,R.drawable.no_top_arrow_bg,R.color.white,0);		case R.id.btn_goods:			currPage = 0;			mLayoutGoods.setVisibility(View.VISIBLE);			mLayoutShop.setVisibility(View.GONE);			mButtonGoods.setBackgroundResource(R.color.application_blue);			mButtonShop.setBackgroundResource(R.color.application_gray_black);			mButtonGoods.setTextColor(Color.parseColor("#ffffff"));			mButtonShop.setTextColor(Color.parseColor("#010101"));			break;		case R.id.btn_shop:			currPage = 1;			mLayoutShop.setVisibility(View.VISIBLE);			mLayoutGoods.setVisibility(View.GONE);			mButtonShop.setBackgroundResource(R.color.application_blue);			mButtonGoods.setBackgroundResource(R.color.application_gray_black);			mButtonShop.setTextColor(Color.parseColor("#ffffff"));			mButtonGoods.setTextColor(Color.parseColor("#010101"));			break;		case R.id.btn_notice:			break;		default:			break;		}	}	private BroadcastReceiver mRefreshReceiver = new BroadcastReceiver() {		@Override		public void onReceive(Context context, Intent intent) {			if (intent == null					|| (intent.getAction() == null || intent.getAction()							.equals(""))) {				return;			}			String action = intent.getAction();			if (action.equals(GlobalParam.ACTION_REFRESH_MERCHANT_GOODS_COUNT)) {				mGoodsCountTextView.setText(WeiYuanCommon.getGoodsCount(1) + "");			}		}	};	public void startSearch() {		switch (currPage) {		case 0:			goodsListFragment.startSearch();			break;		case 1:			shopListFragment.startSearch();			break;		default:			break;		}	}	@Override	protected void onActivityResult(int requestCode, int resultCode, Intent intent) {		super.onActivityResult(requestCode, resultCode, intent);		switch (requestCode) {		case REQUEST_VERIFY_PASSWORD:			if (resultCode == RESULT_OK) {				Intent basketIntent = new Intent();				basketIntent.setClass(mContext, ShoppingManagerActivity.class);				basketIntent.putExtra("type", GlobleType.BASKET_MANAGER);				startActivity(basketIntent);			}		}	}}