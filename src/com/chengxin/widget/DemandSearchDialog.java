package com.chengxin.widget;import java.util.ArrayList;import java.util.List;import com.chengxin.ChatMainActivity;import com.chengxin.R;import com.chengxin.Entity.Demand;import com.chengxin.Entity.Login;import com.chengxin.Entity.LoginResult;import com.chengxin.adapter.DemandAdapter;import com.chengxin.global.GlobalParam;import com.chengxin.global.WeiYuanCommon;import com.chengxin.net.WeiYuanException;import android.app.Dialog;import android.content.Context;import android.content.Intent;import android.os.Bundle;import android.os.Handler;import android.os.Message;import android.text.Editable;import android.text.TextWatcher;import android.view.MotionEvent;import android.view.View;import android.view.inputmethod.InputMethodManager;import android.widget.AdapterView;import android.widget.Button;import android.widget.EditText;import android.widget.ListView;import android.widget.Toast;import android.widget.AdapterView.OnItemClickListener;public class DemandSearchDialog extends Dialog implements OnItemClickListener, android.view.View.OnClickListener{	private List<Demand> mSourceList;	private List<Demand> mSearchList;	private Context mContext;	private Button mCancleBtn;	private EditText mContentEdit;	protected ListView mListView;	private DemandAdapter mAdapter;	public DemandSearchDialog(Context context, List<Demand> sourceList) {		super(context, R.style.ContentOverlay);		mSourceList = sourceList;		mContext =context;	}	public DemandSearchDialog(Context context) {		super(context, R.style.ContentOverlay);		mContext = context;	}	@Override	protected void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		setContentView(R.layout.contact_search_dialog);		initComponent();	}	private void initComponent() {		mCancleBtn = (Button)findViewById(R.id.cancle_btn);		mCancleBtn.setOnClickListener(this);		mSearchList = new ArrayList<Demand>();		mContentEdit = (EditText) findViewById(R.id.searchcontent);		mContentEdit.addTextChangedListener(new TextWatcher() {			@Override			public void onTextChanged(CharSequence s, int start, int before,					int count) {			}			@Override			public void beforeTextChanged(CharSequence s, int start, int count,					int after) {			}			@Override			public void afterTextChanged(Editable s) {				if(mSourceList == null || mSourceList.size()<=0){					return;				}								List<Demand> tempList = new ArrayList<Demand>();								if (s.toString() != null && !s.toString().equals("")) {					for (int i = 0; i < mSourceList.size(); i++) {						String content = mSourceList.get(i).content;												if(content!=null && !content.equals("")){							if (content.contains(s.toString())) {								tempList.add(mSourceList.get(i));							}						}					}				}				if (mSearchList != null) {					mSearchList.clear();				}				mSearchList.addAll(tempList);				updateListView();								if(mSearchList!=null && mSearchList.size()>0){					mListView.setVisibility(View.VISIBLE);				}else{					mListView.setVisibility(View.GONE);				}			}		});		mListView = (ListView) findViewById(R.id.contact_list);		mListView.setVisibility(View.GONE);		mListView.setDivider(mContext.getResources().getDrawable(R.drawable.order_devider_line));		mListView.setCacheColorHint(0);		mListView.setOnItemClickListener(this);//		mListView.setSelector(mContext.getResources().getDrawable(R.drawable.transparent_selector));	}	private void updateListView() {		if(mSearchList != null && mSearchList.size() != 0){			mListView.setVisibility(View.VISIBLE);		}		if(mAdapter != null){			mAdapter.notifyDataSetChanged();			return;		} else if (mSearchList != null) {			mAdapter = new DemandAdapter(mContext, mSearchList);			mListView.setAdapter(mAdapter);		}	}	@Override	public void onItemClick(AdapterView<?> listView, View convertView, int position, long uid) {		beginChatWithUid(uid);	}		@Override	public void onClick(View v) {		DemandSearchDialog.this.dismiss();	}		private void hideKeyBoard(){		if(getCurrentFocus()!=null && getCurrentFocus().getWindowToken()!=null){			InputMethodManager manager= (InputMethodManager)mContext.getSystemService(Context.INPUT_METHOD_SERVICE);			manager.hideSoftInputFromWindow(getCurrentFocus().getWindowToken(), InputMethodManager.HIDE_NOT_ALWAYS);  		}  	}	@Override	public boolean onTouchEvent(MotionEvent event) {		if(event.getAction() == MotionEvent.ACTION_DOWN){  			if(mSearchList == null || mSearchList.size()<=0){				hideKeyBoard();				DemandSearchDialog.this.dismiss();			}		}  		return super.onTouchEvent(event);	}		protected Handler mHandler = new Handler() {		@Override		public void handleMessage(Message msg) {			super.handleMessage(msg);			switch (msg.what) {			case GlobalParam.MSG_GET_CONTACT_DATA:				LoginResult login = (LoginResult)msg.obj;								if(login == null){					Toast.makeText(mContext, R.string.commit_data_error,Toast.LENGTH_LONG).show();					return;				}								if(login.mState.code == 0){					Login user = login.mLogin;										if(user != null){						Intent intent = new Intent(mContext, ChatMainActivity.class);						user.mIsRoom = 100;						intent.putExtra("data", user);						mContext.startActivity(intent);						DemandSearchDialog.this.dismiss();					}				} else {					Toast.makeText(mContext, login.mState.errorMsg,Toast.LENGTH_LONG).show();				}				break;						default:				break;			}		}	};		private void beginChatWithUid(final long uid) {		if (uid > 0) {			if (!WeiYuanCommon.getNetWorkState()) {				return;			}			new Thread(){				public void run() {					try {						LoginResult user = WeiYuanCommon.getWeiYuanInfo().getUserInfo(String.valueOf(uid).toString());						WeiYuanCommon.sendMsg(mHandler, GlobalParam.MSG_GET_CONTACT_DATA, user);					} catch (WeiYuanException e) {						e.printStackTrace();					} catch (Exception e) {						e.printStackTrace();					}				};			}.start();		}	}}