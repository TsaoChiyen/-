package com.chengxin.profile.shopping;import java.util.ArrayList;import java.util.List;import android.content.Intent;import android.os.Bundle;import android.os.Handler;import android.os.Message;import android.util.Log;import android.view.Gravity;import android.view.View;import android.widget.AdapterView;import android.widget.Button;import android.widget.LinearLayout;import android.widget.Toast;import android.widget.AdapterView.OnItemClickListener;import android.widget.ListView;import com.chengxin.R;import com.chengxin.BaseActivity;import com.chengxin.SendGoodsActivity;import com.chengxin.Entity.Goods;import com.chengxin.Entity.MerchantMenu;import com.chengxin.Entity.PopItem;import com.chengxin.Entity.ShopGoodsList;import com.chengxin.Entity.WeiYuanState;import com.chengxin.adapter.ShopGoodsAdapter;import com.chengxin.adapter.ShopShelfAdapter;import com.chengxin.global.GlobalParam;import com.chengxin.global.WeiYuanCommon;import com.chengxin.net.WeiYuanException;import com.chengxin.widget.PopWindows;import com.chengxin.widget.PopWindows.PopWindowsInterface;public class ShopShelfActivity extends BaseActivity {	protected static final int REQUEST_SHELF_INOF = 1120;	private ListView listView;	private List < Goods > mGoodsList = new ArrayList<Goods>();	private int mStatus;	private LinearLayout mToolBarLayout;	private Button mCategoryButton;	private List<PopItem> mCategoryMenuList;	private PopWindows mPopWindows;	private int mCategoryid;	private ShopShelfAdapter mAdapter;	private Button mUploadButton;	private Button mDownloadButton;	private Button mStatusButton;	private List<PopItem> mStatusMenuList;	private PopWindows mPopStatusWindows;	@Override	protected void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		mContext = this;		setContentView(R.layout.shop_shelf_activity);		initComponent();        if (mGoodsList != null && mGoodsList.size() > 0) {        	mGoodsList.clear();        }                getData();	}	private void getData() {		if (!WeiYuanCommon.getNetWorkState()) {			mBaseHandler.sendEmptyMessage(BASE_MSG_NETWORK_ERROR);			return;		}		new Thread(){			public void run() {				try {					WeiYuanCommon.sendMsg(mBaseHandler, BASE_SHOW_PROGRESS_DIALOG, 							mContext.getResources().getString(R.string.get_dataing));										ShopGoodsList goodsList = WeiYuanCommon.getWeiYuanInfo().getShopGoosList(mCategoryid, mStatus);					mGoodsList.clear();					if (goodsList != null && goodsList.size() > 0) {						mGoodsList.addAll(goodsList.mList);					}					mBaseHandler.sendEmptyMessage(BASE_HIDE_PROGRESS_DIALOG);					WeiYuanCommon.sendMsg(mHandler, GlobalParam.MSG_CHECK_STATE, goodsList.mState);				} catch (WeiYuanException e) {					e.printStackTrace();					WeiYuanCommon.sendMsg(mBaseHandler, BASE_MSG_TIMEOUT_ERROR, 							mContext.getResources().getString(e.getStatusCode()));				} catch (Exception e) {					e.printStackTrace();					mBaseHandler.sendEmptyMessage(BASE_HIDE_PROGRESS_DIALOG);				}			};		}.start();	}	private void initComponent() {		setTitleContent(R.drawable.back_btn, 0, R.string.shop_shelf_activity_title);        mLeftBtn.setOnClickListener(this);                mToolBarLayout = (LinearLayout) findViewById(R.id.tool_bar_layout);        mCategoryButton = (Button)findViewById(R.id.category_btn);        mCategoryButton.setOnClickListener(this);        mStatusButton = (Button)findViewById(R.id.status_btn);        mStatusButton.setOnClickListener(this);        mUploadButton = (Button)findViewById(R.id.upon_shelf_btn);        mUploadButton.setOnClickListener(this);        mDownloadButton = (Button)findViewById(R.id.down_shelf_btn);        mDownloadButton.setOnClickListener(this);        mCategoryMenuList = (List<PopItem>) MerchantMenu.getPopMenuList();        mPopWindows = new PopWindows(mContext, mCategoryMenuList, mToolBarLayout, new PopWindowsInterface() {			@Override			public void onItemClick(int dataId, int position, View view) {				mCategoryid = dataId;				Log.i("DataID", String.valueOf(dataId));				mCategoryButton.setText(mCategoryMenuList.get(position).option);				getData();			}        });        mStatusMenuList = new ArrayList<PopItem>();        mStatusMenuList.add(new PopItem(0, "所有状态"));        mStatusMenuList.add(new PopItem(1, "未上架"));        mStatusMenuList.add(new PopItem(2, "已上架"));        mPopStatusWindows = new PopWindows(mContext, mStatusMenuList, mToolBarLayout, new PopWindowsInterface() {			@Override			public void onItemClick(int dataId, int position, View view) {				mStatus = dataId;				Log.i("DataID", String.valueOf(dataId));				mStatusButton.setText(mStatusMenuList.get(position).option);				getData();			}        });        listView = (ListView)findViewById(R.id.shelf_list);		listView.setOnItemClickListener(mItemClickListener);	}		public void showData() {		mAdapter = new ShopShelfAdapter(mContext, mGoodsList);		listView.setAdapter(mAdapter);	}	@Override	public void onClick(View v) {		super.onClick(v);		switch (v.getId()) {		case R.id.left_btn:			this.finish();			break;					case R.id.category_btn:			mPopWindows.showGroupPopView(mCategoryMenuList,					Gravity.LEFT,					R.drawable.no_top_arrow_bg,					R.color.white,					0);			break;					case R.id.status_btn:			mPopStatusWindows.showGroupPopView(mStatusMenuList,					Gravity.CENTER,					R.drawable.no_top_arrow_bg,					R.color.white,					0);			break;					case R.id.upon_shelf_btn:			changeShelfGoods(2);			break;					case R.id.down_shelf_btn:			changeShelfGoods(1);			break;		default:			break;		}	}	private List<Goods> getSelectedGoods(int status) {		List<Goods> list = new ArrayList<Goods>();		if (mGoodsList.size() > 0) {			for (int i = 0; i < mGoodsList.size(); i ++) {				Goods goods = mGoodsList.get(i);								if (goods.selected) {					goods.selected = false;										if (goods.price > 0 && goods.number > 0) {						goods.status = status;						list.add(goods);					} else {						if (status == 2) {							list.clear();							break;						} else {							goods.status = status;							list.add(goods);						}					}				}			}		}				return list;	}	private void changeShelfGoods(final int status) {		final List<Goods> selectedList = getSelectedGoods(status);				if (selectedList == null || selectedList.size() == 0) {						if (status == 2) {				Toast.makeText(mContext, "请保证要上架的商品都有价格和库存量后再上架", Toast.LENGTH_LONG).show();			}			return;		}		if (!WeiYuanCommon.getNetWorkState()) {			mBaseHandler.sendEmptyMessage(BASE_MSG_NETWORK_ERROR);			return;		}		new Thread(){			public void run() {				try {					WeiYuanCommon.sendMsg(mBaseHandler, BASE_SHOW_PROGRESS_DIALOG, 							mContext.getResources().getString(R.string.get_dataing));										WeiYuanState state = WeiYuanCommon.getWeiYuanInfo().shelfGoods(status, selectedList);					mBaseHandler.sendEmptyMessage(BASE_HIDE_PROGRESS_DIALOG);					WeiYuanCommon.sendMsg(mHandler, GlobalParam.MSG_CHECK_STATE, state);				} catch (WeiYuanException e) {					e.printStackTrace();					WeiYuanCommon.sendMsg(mBaseHandler, BASE_MSG_TIMEOUT_ERROR, 							mContext.getResources().getString(e.getStatusCode()));				} catch (Exception e) {					e.printStackTrace();					mBaseHandler.sendEmptyMessage(BASE_HIDE_PROGRESS_DIALOG);				}			};		}.start();	}	@Override	protected void onActivityResult(int requestCode, int resultCode, Intent data) {		super.onActivityResult(requestCode, resultCode, data);				switch (requestCode) {		case REQUEST_SHELF_INOF:			if (resultCode == RESULT_OK) {				int pos = data.getIntExtra("position", -1);				Goods item = (Goods) data.getExtras().get("data");								if (item != null && pos >= 0) {					mGoodsList.set(pos, item);					mAdapter.notifyDataSetChanged();				}			}						break;		default:			break;		}			}	private OnItemClickListener mItemClickListener = new OnItemClickListener() {		@Override		public void onItemClick(AdapterView<?> sender, View convertView, int position, long id) {			Goods item = mGoodsList.get(position);			Intent intent = new Intent();			intent.setClass(mContext, ShopShelfInfoActivity.class);			intent.putExtra("position", position);			intent.putExtra("data", item);			startActivityForResult(intent, REQUEST_SHELF_INOF);		}	};	private Handler mHandler = new Handler() {		@Override		public void handleMessage(Message msg) {			super.handleMessage(msg);						switch (msg.what) {			case GlobalParam.MSG_CHECK_STATE:				WeiYuanState state = (WeiYuanState)msg.obj;								if(state == null){					Toast.makeText(mContext, R.string.commit_data_error,Toast.LENGTH_LONG).show();					return;				}								if(state.code == 0){					showData();				} else {					Toast.makeText(mContext, state.errorMsg,Toast.LENGTH_LONG).show();				}				break;			default:				break;			}		}			};}